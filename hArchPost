#!/usr/bin/env bash

#hArchPost - Post install - Downloadeded after Harch finishes
# ---------------------------------------------------------------
# Author    : Chaotic_Guru                                       |
# Github    : https://github.com/ChaoticHackingNetwork           |
# Discord   : https://discord.gg/nv445EX (ChaoticHackingNetwork) |
# Version   : 0.1.1		                                 |
# ---------------------------------------------------------------

GREEN='\033[0;32m'
RED='\033[0;31m'
WHITE='\033[0;37m'
YELLOW='\033[0;33m'
PURPLE='\033[0;35m'
RESET='\033[0m'
NEWLINE=$'\n'

installer() {
	#Installs needed packages
	echo -e "${YELLOW}[*] Installing some handy packages...${RESET}"
	pacman -S dkms linux-headers chromium firefox discord dhcpcd iwd mlocate cmake neofetch pulseaudio cherrytree git net-tools dnsutils terminator zsh git fish leafpad --noconfirm
}

desktopEnv() {
	#WIP - Choose DE - If Mate and Nvidia graphics, check comp manager
	echo -e "${GREEN}[!] Choose a Desktop Enviornment${RESET}"
	DEs=("Mate" "KDE" "Gnome" "Cinnamon" "Deepin" "Enlightenment" "Skip")
	select opt in "${DEs[@]}"
	do
		case $opt in 
			"Mate")
				pacman -S mate mate-extra lightdm lightdm-gtk-greeter xorg-server xorg-xinit --noconfirm
				#Disable compositing if nvidia graphics
				NVD='NVIDIA'
				card=$(lspci -vmm | grep VGA -A6)
				case $card in 
					*"$NVD"*)
						#Fixes screen tearing for mulit-head or hybrid graphics
						echo "WIP"
						;;
				esac
				systemctl enable lightdm
				;;
			"KDE")
				pacman -S plasma-meta sddm plasma-desktop xorg-server xorg-xinit --noconfirm
				#If nvidia graphics, add stacked compositer
				NVD='NVIDIA'
				card=$(lspci -vmm | grep VGA -A6)
				case $card in 
					*"$NVD"*)
						pacman -S kwin plasma-wayland-session --noconfirm
						;;
				esac
				systemctl enable sddm
				;;
			"Gnome")
				pacman -S gnome gnome-extra gdm xorg-server xorg-xinit --noconfirm
				systemctl enable gdm
				;;
			"Cinnamon")
				pacman -S cinnamon metacity gnome-shell gdm xorg-server xorg-xinit --noconfirm
				systemctl enable gdm
				;;
			"Deepin")
				pacman -S deepin deepin-extra deepin-kwin lightdm lightdm-deepin-greeter xorg--noconfirm
				#Sed the greeter to conf - WIP
				systemctl enable lightdm
				;;
			"Enlightenment")
				pacman -S enlightenment terminology xorg-server xorg-xinit lxdm --noconfirm
				systemctl enable lxdm
				;;
			"Skip")
				break
				;;
			*) echo -e "${RED}Invalid Option, Try Again...${RESET}"
		esac
	done

}


sublimeInstaller() {
	echo -e "${GREEN}Installing Sublime Text...${RESET}"
	curl -O https://download.sublimetext.com/sublimehq-pub.gpg && pacman-key --add sublimehq-pub.gpg && pacman-key --lsign-key 8A8F901A && rm sublimehq-pub.gpg
	sleep 3
	echo -e "\n[sublime-text]\nServer = https://download.sublimetext.com/arch/stable/x86_64" | tee -a /etc/pacman.conf
	sleep 3
	pacman -Syu sublime-text --noconfirm
}

vidDriver() {
	echo ${NEWLINE}
	echo ${NEWLINE}
	echo -e "${GREEN}[*] Gathering Graphics info...${RESET}"
	echo ${NEWLINE}
	echo ${NEWLINE}
	echo -e "${YELLOW}[!] Installing drivers...${RESET}"
	sleep 2
	str=$(lspci -vmm | grep VGA -A6)
	AMD='AMD'
	NVD='NVIDIA'
	case $str in
		*"$AMD"*)
			echo -e "${YELLOW}[!] Installing AMD Drivers...${RESET}"
			pacman -S xf86-video-ati xf86-video-amdgpu mesa --noconfirm
			;;

		*"$NVD"*)
			echo -e "${GREEN}[!] Installing NVIDIA Drivers...${RESET}"
			pacman -S nvidia nvidia-settings nvidia-utils glxinfo --noconfirm
			;;
	esac

}

userInfo() {
	#Set root password
	echo -e "${YELLOW}[!] Please set ROOT password!!!${RESET}"
	passwd
	#Create a new user
	read -p "[*] Enter a new Username: " username
	echo -e "${GREEN}------> hArch welcomes you $username! <------${RESET}"
	useradd -mg users -G wheel,power,storage,uucp,network -s /usr/bin/fish $username
	echo '%wheel ALL=(ALL:ALL) ALL' >> /etc/sudoers.d/wheel_group
    	chmod 440 /etc/sudoers.d/wheel_group
	echo -e "${YELLOW}[!] Please set your password now!${RESET}"
	passwd $username
}

booter() {
	echo ${NEWLINE}
	echo ${NEWLINE}
	echo -e "${GREEN}[*] Setting Booterloader...${RESET}"
	drives=$(lsblk -f)
	echo -e "${YELLOW}$drives${RESET}${NEWLINE}"
	read -p "Enter Drive to install Booterloader [Example: /dev/nvme0n1p1]: " drive
	echo "If BIOS, attach bootloader to drive: ex- /dev/sda"
	echo "If UEFI, attach bootloader to partition: ex- /dev/nvme0n1p1"
	if [[ -d "/sys/firmware/efi" ]]
	then
	pacman -S efibootmgr grub dosfstools mtools os-prober --noconfirm
	grub-install --target=x86_64-efi --bootloader-id=HARCH_UEFI --efi-directory=/boot/EFI --recheck
	grub-mkconfig -o /boot/grub/grub.cfg
	mkinitcpio -p linux
	else
	pacman -S grub --noconfirm
	grub-install --target=i386-pc $drive --recheck
	grub-mkconfig -o /boot/grub/grub.cfg
	mkinitcpio -p linux

	fi
}

blackArch() {
	#Install BlackArch Mirror & download tools list
	echo ${NEWLINE}
	echo -e "${GREEN}Installing BlackArch Repo... HANG TIGHT!!!${RESET}"
	curl -O https://blackarch.org/strap.sh
	chmod +x strap.sh
	./strap.sh /dev/null 2>&1
	
}

vimSetup() {
	read -p 'Do you want to add Bunle to VIM? [y/n]: ' vim
	if [[ $vim == 'y' ]]
	then 
	curl -O https://raw.githubusercontent.com/ChaoticHackingNetwork/hArch/main/vimrc_bundle_conf
	users=$(ls /home)
	mv vimrc_bundle_conf /home/$users/.vimrc
	else
	echo "Skipping"
	
	fi
}


complete() {
	#Successfully Installed
	neofetch
	echo ${NEWLINE}
	echo -e "${GREEN}[!] Harch has been succesfully installed on your system"
	echo ""
	echo -e "Hack the Universe $username${RESET}"
	echo ""
	echo""
	echo -e "${YELLOW}[!] A reboot should now take place"
	echo "[!] Run the following commands to reboot properly!"
	echo ""
	echo  "[1]: exit"
	echo  "[2]: umount -a"
	echo -e "[3]: reboot${RESET}"

	exit
}


installer
sleep 3
clear
userInfo
sleep 3
clear
vidDriver
sleep 3
clear
booter
sleep 3
clear
sublimeInstaller
sleep 3
blackArch
sleep 3
clear
vimSetup
sleep 3
clear
desktopEnv
sleep 3
clear

complete
